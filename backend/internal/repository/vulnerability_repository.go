package repository

import (
	"github.com/david-santa/vulkyra/backend/internal/models"
	"gorm.io/gorm"
)

func GetAllVulnerabilities(db *gorm.DB) ([]models.Vulnerability, error) {
	var vulns []models.Vulnerability
	err := db.
		Model(&models.Vulnerability{}).
		Select(`vulnerabilities.*, assets.fqdn as asset_name, teams.team_name as owner_name`).
		Joins(`LEFT JOIN assets ON vulnerabilities.asset_id = assets.asset_id`).
		Joins(`LEFT JOIN teams ON vulnerabilities.owner_id = teams.team_id`).
		Find(&vulns).Error
	return vulns, err
}

func GetTeamVulnerabilities(db *gorm.DB, teamID string) ([]models.Vulnerability, error) {
	var vulns []models.Vulnerability
	err := db.
		Model(&models.Vulnerability{}).
		Select(`vulnerabilities.*, assets.fqdn as asset_name, teams.team_name as owner_name`).
		Joins(`LEFT JOIN assets ON vulnerabilities.asset_id = assets.asset_id`).
		Joins(`LEFT JOIN teams ON vulnerabilities.owner_id = teams.team_id`).
		Where("vulnerabilities.owner_id = ?", teamID).
		Find(&vulns).Error
	return vulns, err
}
